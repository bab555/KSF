{# è¿™æ˜¯ä¸€ä¸ªæ›´ä¸ºæ™ºèƒ½å’Œç»“æ„åŒ–çš„Jinja2æ¨¡æ¿ï¼Œç”¨äºæ¸²æŸ“ç”±KSFæ¡†æ¶ç”Ÿæˆçš„ResonancePacketã€‚
   å®ƒåˆ©ç”¨åœ¨PromptAssemblerä¸­æ³¨å†Œçš„`processors`å…¨å±€æ¨¡å—æ¥è‡ªåŠ¨æå–å’Œç»„ç»‡ä¿¡æ¯ã€‚ #}

{%- set all_knowledge = packet.primary_atoms + packet.context_atoms -%}

{# --- 1. æ‰§è¡Œæ‘˜è¦ (Executive Summary) --- #}
{# åœ¨ç­”æ¡ˆçš„å¼€å¤´ï¼Œé¦–å…ˆåˆ©ç”¨processorsæ¨¡å—å¯¹æ‰€æœ‰çŸ¥è¯†è¿›è¡Œåˆ†æï¼Œå¹¶å‘ˆç°æœ€é‡è¦çš„ä¿¡æ¯ã€‚ #}

{%- set risks = processors.tag_risk_factors(all_knowledge) -%}
{%- set actions = processors.extract_action_items(all_knowledge) -%}
{%- set pros_cons = processors.tag_pros_cons(all_knowledge) -%}

### ç»¼åˆæ´å¯Ÿæ‘˜è¦ (Executive Insights)

{% if risks %}
**âš ï¸ å…³é”®é£é™©ä¸æ³¨æ„äº‹é¡¹ (Key Risks & Considerations)**
{% for item in risks %}
- {{ item }}
{% endfor %}
{% endif %}

{% if actions %}
**ğŸ¯ æ ¸å¿ƒè¡ŒåŠ¨å»ºè®® (Key Action Items)**
{% for item in actions %}
- {{ item }}
{% endfor %}
{% endif %}

{% if pros_cons.pros or pros_cons.cons %}
**âš–ï¸ ä¼˜åŠ£åŠ¿åˆ†æ (Pros & Cons)**
{% if pros_cons.pros %}
**ä¼˜åŠ¿ (Pros):**
{% for item in pros_cons.pros %}
- {{ item }}
{% endfor %}
{% endif %}
{% if pros_cons.cons %}
**åŠ£åŠ¿ (Cons):**
{% for item in pros_cons.cons %}
- {{ item }}
{% endfor %}
{% endif %}
{% endif %}

---

### åŸå§‹æŸ¥è¯¢ (Original Query)
> {{ query }}

---

### è¯¦ç»†çŸ¥è¯†æ”¯æ’‘ (Detailed Knowledge Support)

{% if not all_knowledge and not packet.emerged_concepts %}
*æŠ±æ­‰ï¼Œæ ¹æ®æ‚¨çš„æŸ¥è¯¢ï¼Œæœªèƒ½åœ¨çŸ¥è¯†åº“ä¸­æ‰¾åˆ°ç›¸å…³ä¿¡æ¯ã€‚*
{% endif %}

{% if packet.primary_atoms %}
**âš›ï¸ æ ¸å¿ƒçŸ¥è¯†æ´å¯Ÿ (Primary Knowledge)**
*è¿™æ˜¯æ ¹æ®æ‚¨çš„æŸ¥è¯¢ï¼Œä»æ‚¨çš„æ ¸å¿ƒçŸ¥è¯†åº“ä¸­æ‰¾åˆ°çš„æœ€ç›´æ¥ã€æœ€ç›¸å…³çš„ä¿¡æ¯ã€‚*

{% for item in packet.primary_atoms %}
- **{{ item.content | first_line | trim }}**
  `ID: {{ item.id }} | Score: {{ "%.3f"|format(item.final_score) }} (Sim: {{ "%.2f"|format(item.original_similarity) }}, Pagerank: {{ "%.2f"|format(item.pagerank_weight) }})`
  {%- set other_lines = item.content | other_lines | trim -%}
  {% if other_lines %}
  > {{ other_lines | replace('\n', '\n> ') }}
  {% endif %}
{% endfor %}
{% endif %}

{% if packet.context_atoms %}
**ğŸ§­ ç›¸å…³èƒŒæ™¯æŒ‡å¼• (Contextual Knowledge)**
*è¿™æ˜¯æ ¹æ®æ‚¨çš„æŸ¥è¯¢ï¼Œä»ä¸Šä¸‹æ–‡çŸ¥è¯†åº“ä¸­æ‰¾åˆ°çš„ç›¸å…³èƒŒæ™¯ã€åŸåˆ™æˆ–æ³¨è§£ä¿¡æ¯ã€‚*

{% for item in packet.context_atoms %}
- **{{ item.content | first_line | trim }}**
  `ID: {{ item.id }} | Score: {{ "%.3f"|format(item.final_score) }} (Sim: {{ "%.2f"|format(item.original_similarity) }}, Pagerank: {{ "%.2f"|format(item.pagerank_weight) }})`
  {%- set other_lines = item.content | other_lines | trim -%}
  {% if other_lines %}
  > {{ other_lines | replace('\n', '\n> ') }}
  {% endif %}
{% endfor %}
{% endif %}

{% if packet.emerged_concepts %}
**ğŸ’¡ æ¦‚å¿µç«èŠ± (Emerged Concepts)**
*é™¤äº†ç›´æ¥ä¿¡æ¯å¤–ï¼Œç³»ç»Ÿè¿˜åœ¨è¯­ä¹‰ç©ºé—´ä¸­å‘ç°äº†ä»¥ä¸‹ä¸æ‚¨æŸ¥è¯¢é«˜åº¦ç›¸å…³çš„æ¦‚å¿µï¼Œå®ƒä»¬æˆ–è®¸èƒ½ä¸ºæ‚¨æä¾›æ–°çš„æ€è€ƒè§’åº¦ã€‚*

{% for concept in packet.emerged_concepts %}
- **{{ concept.concept }}** `(Score: {{ "%.3f"|format(concept.score) }})`
{% endfor %}
{% endif %}

---
*Powered by KSF v5 - Unified Resonance Model* 